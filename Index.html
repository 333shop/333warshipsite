<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>333warship</title>
  <style>
    :root {
      --bg-black: #000000;
      --gray-med: #2a2a2a;
      --gray-light: #444444;
      --accent: #ff3333;
      --accent-hover: #ff1a1a;
    }
    body {
      margin: 0;
      background: var(--bg-black) url('https://cdn.discordapp.com/attachments/1472431047315685497/1474196428875108584/02855507-6CD6-4CC1-9E82-E3C9898575AB.jpg?ex=6998f7e9&is=6997a669&hm=af3e729535faf7bc88f7fa198aa2847823ab9832371d91e755aea7881d351cfb&') no-repeat center center fixed;
      background-size: cover;
      color: #e0e0e0;
      min-height: 100vh;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
    }
    header { padding: 1rem; background: rgba(0,0,0,0.6); text-align: center; }
    h1 { color: var(--accent); text-shadow: 0 0 15px var(--accent); margin: 0; font-size: 2.5rem; }
    main { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem; }
    .container {
      background: rgba(26,26,26,0.88);
      backdrop-filter: blur(12px);
      padding: 3rem;
      border-radius: 20px;
      box-shadow: 0 0 50px rgba(255,51,51,0.3);
      text-align: center;
      max-width: 500px;
      width: 100%;
      border: 1px solid #444;
    }
    button {
      padding: 1.2rem 2.5rem;
      background: var(--accent);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1.3rem;
      cursor: pointer;
      transition: all 0.3s;
      margin: 1rem;
    }
    button:hover { background: var(--accent-hover); transform: scale(1.05); }
    #plus-btn {
      position: fixed;
      bottom: 40px;
      right: 40px;
      width: 80px;
      height: 80px;
      background: var(--accent);
      border: none;
      border-radius: 50%;
      font-size: 4rem;
      color: white;
      cursor: pointer;
      box-shadow: 0 0 40px rgba(255,51,51,0.5);
      display: none;
      transition: all 0.3s;
    }
    #plus-btn:hover { transform: scale(1.1); background: var(--accent-hover); }
    #form-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: #2a2a2a;
      padding: 3rem;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
    }
    input {
      width: 100%;
      padding: 1rem;
      margin: 1rem 0;
      background: #444;
      border: 1px solid #555;
      border-radius: 8px;
      color: white;
      font-size: 1.1rem;
    }
    input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 10px rgba(255,51,51,0.4); }
    #file-preview { color: #aaa; margin: 1rem 0; }
    #welcome, #status { font-size: 1.2rem; margin: 1.5rem 0; }
  </style>
</head>
<body>

<header>
  <h1>333warship</h1>
</header>

<main id="main-content">
  <div class="container" id="login-page">
    <h2>Access Restricted</h2>
    <button onclick="discordLogin()">Login with Discord</button>
    <p id="status">Only authorized users</p>
  </div>

  <div class="container" id="dashboard-page" style="display:none;">
    <h2>Dashboard</h2>
    <p id="welcome">Loading...</p>
    <button id="plus-btn">+</button>
  </div>
</main>

<div id="form-modal">
  <div class="modal-content">
    <h2>Add Product</h2>
    <input id="prod-name" placeholder="Product Name" />
    <input id="prod-price" type="number" placeholder="Price ($)" step="0.01" />
    <input id="prod-file" type="file" accept="*/*" />
    <div id="file-preview"></div>
    <button onclick="submitProduct()">Submit</button>
    <button onclick="closeModal()" style="background:#555;">Cancel</button>
  </div>
</div>

<script>
  // Config
  const CLIENT_ID = '1474196601030312088';
  const REDIRECT_URI = window.location.origin + '/#callback'; // Uses hash for single-file
  const SCOPES = 'identify email'; // minimal
  const ALLOWED_IDS = ['1472399360779092245', '1177322382306844794', '1289708914656542784']; // your list

  // Simple router via hash
  function route() {
    const hash = window.location.hash.substring(1);
    const loginPage = document.getElementById('login-page');
    const dashPage = document.getElementById('dashboard-page');

    if (hash === 'callback') {
      handleCallback();
    } else if (localStorage.getItem('333warship_user')) {
      showDashboard();
    } else {
      loginPage.style.display = 'block';
      dashPage.style.display = 'none';
    }
  }

  function discordLogin() {
    const state = Math.random().toString(36).substring(2);
    localStorage.setItem('oauth_state', state);
    const authUrl = `https://discord.com/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(SCOPES)}&state=${state}`;
    window.location.href = authUrl;
  }

  async function handleCallback() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const token = params.get('access_token');
    const returnedState = params.get('state');
    const storedState = localStorage.getItem('oauth_state');

    if (!token || returnedState !== storedState) {
      alert('Auth failed or tampered.');
      window.location.hash = '';
      return;
    }

    localStorage.removeItem('oauth_state');
    window.location.hash = ''; // clean URL

    try {
      const res = await fetch('https://discord.com/api/users/@me', {
        headers: { Authorization: `Bearer ${token}` }
      });
      const user = await res.json();
      if (!user.id) throw new Error();

      localStorage.setItem('333warship_user', JSON.stringify({ id: user.id, email: user.email || 'N/A' }));
      showDashboard();
    } catch (e) {
      alert('Failed to fetch Discord user info.');
      window.location.hash = '';
    }
  }

  function showDashboard() {
    const userData = JSON.parse(localStorage.getItem('333warship_user') || '{}');
    if (!userData.id) return window.location.hash = '';

    document.getElementById('login-page').style.display = 'none';
    document.getElementById('dashboard-page').style.display = 'block';
    document.getElementById('welcome').textContent = `Welcome, Discord User ${userData.id} (${userData.email})`;

    const plusBtn = document.getElementById('plus-btn');
    if (ALLOWED_IDS.includes(userData.id)) {
      plusBtn.style.display = 'block';
    }
  }

  document.getElementById('plus-btn').onclick = () => {
    document.getElementById('form-modal').style.display = 'flex';
  };

  function closeModal() {
    document.getElementById('form-modal').style.display = 'none';
  }

  document.getElementById('prod-file').onchange = (e) => {
    const file = e.target.files[0];
    document.getElementById('file-preview').textContent = file ? `Selected: ${file.name} (${(file.size / 1024).toFixed(2)} KB)` : '';
  };

  function submitProduct() {
    const name = document.getElementById('prod-name').value.trim();
    const price = document.getElementById('prod-price').value;
    const fileInput = document.getElementById('prod-file');
    const file = fileInput.files[0];

    if (!name || !price || !file) return alert('Fill everything.');

    const reader = new FileReader();
    reader.onload = (e) => {
      const products = JSON.parse(localStorage.getItem('333warship_products') || '[]');
      products.push({ name, price, fileName: file.name, fileBase64: e.target.result });
      localStorage.setItem('333warship_products', JSON.stringify(products));
      alert(`"${name}" added @ $${price} (local storage only)`);
      closeModal();
      // Clear inputs
      document.getElementById('prod-name').value = '';
      document.getElementById('prod-price').value = '';
      fileInput.value = '';
      document.getElementById('file-preview').textContent = '';
    };
    reader.readAsDataURL(file);
  }

  // Init
  window.addEventListener('hashchange', route);
  route(); // on load
</script>
</body>
</html>
